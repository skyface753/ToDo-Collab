<!DOCTYPE html>
<html>
  <head>
    <title>Chat</title>
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/static/css/main.css"
    />
  </head>
  <body onload="init()">
    <main>
    <h1>WebSocket Chat</h1>
    <h2>Your ID: <span id="ws-id"> {{user.id}} </span></h2>
    <h2>Collection: {{collection.name}}</h2>
    <form action="" onsubmit="sendMessage(event)">
      {# Message Input #}
      <input
        type="text"
        id="todoTitle"
        autocomplete="off"
        placeholder="Title"
      />
      <input
        type="text"
        id="todoDescription"
        autocomplete="off"
        placeholder="Description"
      />
      <button>Send</button>
    </form>
    <form action="" onsubmit="addToCollection(event)">
      {# Message Input #}
      <input
        type="text"
        id="user_id_to_add"
        autocomplete="off"
        placeholder="User ID"
      />
      <button class="secondary">Add to {{collection.id}}</button>
    </form>
    <section class="items" id="todos"></section>
    <script>
      user_id = '{{user._id}}';
      var ws = new WebSocket(
        `ws://localhost:8000/api/v1/todo/ws/{{collection.id}}?token={{token}}`
      );
      ws.onmessage = function (event) {
        var todos = document.getElementById('todos');
        try {
          var todo = JSON.parse(event.data);
          processTodo(todo);
          console.log("Received: '" + event.data + "'");
        } catch (e) {
          console.log(event.data);
        }
      };
      function init() {
        json = {{todossosos|tojson|safe}};
        console.log(json);
        json.forEach((todo) => {
          todo = JSON.parse(todo);
          processTodo({
            title: todo.title,
            description: todo.description,
          });
        });
      }
      function processTodo(todo) {
        var todos = document.getElementById('todos');
        var todoItem = document.createElement('article');
        todoItem.className = 'item';
        var todoTitle = document.createElement('h3');
        var todoDescription = document.createElement('p');
        todoTitle.textContent = todo.title;
        todoDescription.textContent = todo.description;
        todoItem.appendChild(todoTitle);
        todoItem.appendChild(todoDescription);
        todos.appendChild(todoItem);
      }
      function sendMessage(event) {
        var todoTitle = document.getElementById('todoTitle');
        var todoDescription = document.getElementById('todoDescription');
        // To jsson
        var todo = {
          title: todoTitle.value,
          description: todoDescription.value,
        };
        // To string
        var todoString = JSON.stringify(todo);
        ws.send(todoString);
        todoTitle.value = '';
        todoDescription.value = '';
        event.preventDefault();
      }
      async function addToCollection(event) {
        event.preventDefault();
        // Send to server put with fetch
        var user_id_to_add = document.getElementById('user_id_to_add');
        var user_id_to_add_value = user_id_to_add.value;
        var url = '/api/v1/member/create';
        var data = {
          user_id: user_id_to_add_value,
          collection_id: '{{collection.id}}',
        };
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        })
          .then((response) => {
            if (response.redirected) {
              alert('User already in collection');
            } else {
              return response;
            }
          })
          .catch((error) => {
            console.log(error);
          });

        const content = await response.json();
        console.log(content);
        user_id_to_add.value = '';
      }
    </script>
    </main>
  </body>
</html>
